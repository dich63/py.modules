# -*- coding: utf-8 -*-
"""
Created on Thu Jan 17 05:06:14 2019

@author: wwww
"""
import ltx.mm as mm;
from jsonrpc.jsonclass import config;
import numpy as np;
from jsonrpc.ndarray_marshal import js2np

def objref_unmarshal(data,flink):
    if data[0:7]=='objref:':
        o=mm.bindObject(data);
        b=mm.mm_buffer(o);
        r=b.toarray(copy=not flink);
        if not flink:
            b.detach();
        return r;
    else:
        return None;


#srvsc=mm.bindObject('script');
#stubcache=srvsc('stubcache=bindObject("stub.cache")');
stubcache=mm.bindObject('stub.cache');    

def objref_marshal(a):
    
    global stubcache
    ma=mm.mm_buffer_from_array(a) 
    ma.detach();
    return stubcache(ma.obj);
    #return srvsc('stubcache($$[0])',ma.obj);



config.classes.ipc_marshal['unmarshal']= objref_unmarshal;    
config.classes.ipc_marshal['marshal']= objref_marshal;    
 
def __clear_cache__():
     global stubcache
     return stubcache(-1,0);
 
config.classes.ipc_marshal['cache']=__clear_cache__;


    